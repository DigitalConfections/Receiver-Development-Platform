<!DOCTYPE html>

<head>
    <title>Transmitter Test</title>
    <style type="text/css">
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }

        .incbutton {
            background-color: blue;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }

        .decbutton {
            background-color: blue;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
        }

        input[type="text"]:value {
            -webkit-text-font-weight: bold;
        }

        ::placeholder {
            color: red;
            opacity: 1;
            /* Firefox */
        }

        :-ms-input-placeholder {
            /* Internet Explorer 10-11 */
            color: red;
        }

        ::-ms-input-placeholder {
            /* Microsoft Edge */
            color: red;
        }

        ::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            color: red;
        }

        ::-moz-placeholder {
            /* Firefox 19+ */
            color: red;
        }

        :-moz-placeholder {
            /* Firefox 18- */
            color: red;
        }

        iframe,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        p,
        blockquote,
        pre,
        a,
        abbr,
        acronym,
        address,
        big,
        cite,
        code,
        del,
        dfn,
        em,
        img,
        ins,
        kbd,
        q,
        s,
        samp,
        small,
        strike,
        strong,
        sub,
        sup,
        tt,
        var,
        b,
        u,
        i,
        center,
        dl,
        dt,
        dd,
        ol,
        ul,
        li,
        fieldset,
        form,
        label,
        legend,
        table,
        caption,
        tbody,
        tfoot,
        thead,
        tr,
        th,
        td,
        article,
        aside,
        canvas,
        details,
        embed,
        figure,
        figcaption,
        footer,
        header,
        hgroup,
        menu,
        nav,
        output,
        ruby,
        section,
        summary,
        time,
        mark,
        audio,
        video {
            margin: 0;
            /*      padding: 0; */
            /*      border: 0; */
            font-size: 100%;
            font: inherit;
            vertical-align: baseline;
        }

        #overlay {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2;
            cursor: pointer;
        }

        #overlayText {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 50px;
            font-family: verdana;
            color: white;
            transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
        }

    </style>
</head>

<body onload="javascript:start();">
    <script>
        var g_timer = 0;
        var g_timeUpdateTimer = 0;
        var g_homeTimer = 0;
        var g_eventRadioBand = "";
        var g_timedOut = false;

        var g_freq1FrequencyHz = "";

        var g_numberOfOpenWebSockets = 0;
        var g_stillConnected = 0;
        var g_stillDisconnected = 60;
        var g_lastPacketTime = 0;
        var g_webSocketTxTimer = 0;
        var g_lastSocketTxMessage;
        var g_transmitterTimeMs = 0;
        var g_websock = null;
        var g_timesync_rcvd = 0;

        var g_eventIsRunning = false;

        ///////////////////////////////
        // Settings
        var g_typeTxNames = [{
            name: "Name",
            indices: "0:0"
        }]; /* Human readable "role" name: "Home", and indices: "0:1" */
        var g_selectedTxType;

        var g_eventTableData = [{
            power: "Power",
            modulation: "Modulation",
            band: "Band",
            freq: "Frequency",
            pattern: "Pattern",
            callsign: "ID",
            sleep: "Sleep",
            codespeed: ""
        }]; /* Event data to display in a table header */

        var g_modulationType = ["CW", "AM"];
        var g_powerLevelType = ["0", "10", "50", "100", "200", "300", "400", "500", "600", "700", "800", "900", "1000", "1100", "1200", "1300", "1400", "1500", "1600", "1700", "1800", "1900", "2000"];
        var g_radioBandType = ["80", "2"];

        var g_typeFrequency = [{
            frequency: 3565000,
            role: "80m"
        }, {
            frequency: 144550000,
            role: "2m"
        }]; /* Frequency used by transmitters in that "role" */

        var g_selectedEvent = "";
        var g_powerLevel = g_powerLevelType[5];
        var g_modulation = g_modulationType[0];
        var g_eventRadioBand = g_radioBandType[0];

        ///////////////////////////////

        function displayEvents(erase) {
            var eventNum = g_eventTableData.length;
            var eventTable = document.getElementById("eventTable");
            var tableRows = eventTable.getElementsByTagName('tr');
            var rowCount = tableRows.length;

            console.log("rowCount = ", rowCount);

            if (erase == true) {
                for (var x = rowCount - 1; x >= 0; x--) {
                    eventTable.removeChild(tableRows[x]);
                }

                eventTable.appendChild(eventRow(g_eventTableData[0], true));

                for (var i = 1; i < eventNum; i++) {
                    eventTable.appendChild(eventRow(g_eventTableData[i], false));
                }
            } else {
                console.log("Refreshing table cells");
                for (var i = 1, row; row = eventTable.rows[i]; i++) {
                    var rowData = g_eventTableData[i];
                    for (var j = 0, col; col = row.cells[j]; j++) {
                        col = rowData[j];
                    }
                }
            }
        }

        function eventSelect(selection) {
            if (g_selectedEvent != selection) {
                var btext = "EVENT_NAME," + selection;
                console.log(btext);
                sendToSocket(btext);
                g_selectedEvent = selection;
            }
        }

        function eventRunSelect(selection) {
            if (g_selectedEvent != selection) {
                var btext = "EVENT_NAME," + selection;
                console.log(btext);
                sendToSocket(btext);
                g_selectedEvent = selection;
            }

            sendTest();
        }

        function eventStopSelect(selection) {
            if (g_selectedEvent != selection) {
                var btext = "EVENT_STOP," + selection;
                console.log(btext);
                sendToSocket(btext);
                g_selectedEvent = selection;
            }

            sendTest();
        }

        function sleepAction() {
            var btn = document.getElementById("sleepButton");
            var btext = "SLEEP";
            btn.setAttribute("style", "background-color: #FF0000;");
            console.log(btext);
            sendToSocket(btext);
        }

        function keyAction() {
            var btn = document.getElementById("keyButton");

            if (btn.value == "Send") {
                btn.value = "Stop";
                btn.setAttribute("style", "background-color: #FF0000;");
                sendBand();
                setTimeout(function() {
                    sendPower();
                }, 200);
                setTimeout(function() {
                    sendModulation();
                }, 400);
                setTimeout(function() {
                    sendFrequency();
                }, 600);
                setTimeout(function() {
                    sendPattern();
                }, 800);
                //sendCall();
                setTimeout(function() {
                    sendKeyDown();
                }, 1000);
            } else {
                btn.value = "Send";
                var btext = "KEY_UP";
                btn.setAttribute("style", "background-color: #4CAF50;");
                console.log(btext);
                sendToSocket(btext);
            }
        }

        function eventRow(rowData, isHeader) {
            var row = document.createElement("tr");
            var cellText;

            console.log("rowData = ", rowData);

            if (isHeader == true) {
                row.setAttribute("style", "font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;");

                // create cells in row
                var cell0 = document.createElement("td");
                cell0.setAttribute("border", "1px solid black");
                row.appendChild(cell0);

                var cell1 = document.createElement("td");
                cellText = document.createTextNode(rowData.name);
                cell1.setAttribute("border", "1px solid black");
                cell1.appendChild(cellText);
                row.appendChild(cell1);

                var cell2 = document.createElement("td");
                cellText = document.createTextNode(rowData.version);
                cell2.setAttribute("border", "1px solid black");
                cell2.appendChild(cellText);
                row.appendChild(cell2);

                var cell3 = document.createElement("td");
                cellText = document.createTextNode(rowData.start);
                cell3.setAttribute("border", "1px solid black");
                cell3.appendChild(cellText);
                row.appendChild(cell3);

                var cell4 = document.createElement("td");
                cellText = document.createTextNode(rowData.finish);
                cell4.setAttribute("border", "1px solid black");
                cell4.appendChild(cellText);
                row.appendChild(cell4);

                var cell5 = document.createElement("td");
                cellText = document.createTextNode(rowData.role);
                cell5.setAttribute("border", "1px solid black");
                cell5.appendChild(cellText);
                row.appendChild(cell5);

                var cell6 = document.createElement("td");
                cellText = document.createTextNode(rowData.sleep);
                cell6.setAttribute("border", "1px solid black");
                cell6.appendChild(cellText);
                row.appendChild(cell6);
            } else {
                // create cells in row
                var btn = document.createElement('input');
                var entry = rowData.name;
                btn.type = "button";
                btn.className = "button";
                btn.id = "keyButton";
                btn.value = "Send";
                btn.onclick = (function(entry) {
                    return function() {
                        keyAction();
                    }
                })(entry);

                var cell0 = document.createElement("td");
                cell0.setAttribute("border", "1px solid black");
                cell0.appendChild(btn);
                row.appendChild(cell0);



                // Power Level 0-2000
                var cell1 = document.createElement("td");
                cell1.setAttribute("border", "1px solid black");

                var sel = document.createElement('select'),
                    option,
                    i = 0,
                    il = g_powerLevelType.length;

                sel.setAttribute("onchange", "pwrClick()");
                sel.setAttribute("id", "pwrSelect");
                sel.setAttribute("style", "font-family:verdana; font-size:15px; color:blue; font-weight:bold;");

                for (; i < il; i += 1) {
                    option = document.createElement('option');
                    option.setAttribute('value', g_powerLevelType[i]);
                    option.appendChild(document.createTextNode(g_powerLevelType[i]));
                    if (g_powerLevelType[i] == g_powerLevel) {
                        option.setAttribute("selected", "true");
                    }

                    sel.appendChild(option);
                    console.log("Freq option:", g_powerLevelType[i]);
                }


                cell1.appendChild(sel);
                row.appendChild(cell1);


                // Modulation Format CW or AM
                var cell2 = document.createElement("td");
                cell2.setAttribute("border", "1px solid black");

                sel = document.createElement('select'),
                    option,
                    i = 0,
                    il = g_modulationType.length;

                sel.setAttribute("onchange", "modClick()");
                sel.setAttribute("id", "modSelect");
                sel.setAttribute("style", "font-family:verdana; font-size:15px; color:blue; font-weight:bold;");

                for (; i < il; i += 1) {
                    option = document.createElement('option');
                    option.setAttribute('value', g_modulationType[i]);
                    option.appendChild(document.createTextNode(g_modulationType[i]));
                    if (g_modulationType[i] == g_modulation) {
                        option.setAttribute("selected", "true");
                    }

                    sel.appendChild(option);
                    console.log("Modulation Type:", g_modulationType[i]);
                }


                cell2.appendChild(sel);
                row.appendChild(cell2);



                // Radio Band 80m or 2m
                cell1 = document.createElement("td");
                cell1.setAttribute("border", "1px solid black");

                sel = document.createElement('select'),
                    option,
                    i = 0,
                    il = g_radioBandType.length;

                sel.setAttribute("onchange", "bandClick()");
                sel.setAttribute("id", "bandSelect");
                sel.setAttribute("style", "font-family:verdana; font-size:15px; color:blue; font-weight:bold;");

                for (; i < il; i += 1) {
                    option = document.createElement('option');
                    option.setAttribute('value', g_radioBandType[i]);
                    option.appendChild(document.createTextNode(g_radioBandType[i]));
                    if (g_radioBandType[i] == g_eventRadioBand) {
                        option.setAttribute("selected", "true");
                    }

                    sel.appendChild(option);
                    console.log("Band:", g_radioBandType[i]);
                }


                cell1.appendChild(sel);
                row.appendChild(cell1);



                // Set Frequency
                var cell3 = document.createElement("td");
                var b = document.createElement('input');
                b.setAttribute("type", "button");
                b.setAttribute("id", "frequencyButton");
                b.setAttribute("class", "incbutton");
                b.setAttribute("value", freqDotFormat(g_typeFrequency[0].frequency));
                b.setAttribute("onclick", "toggleFreqSettings();");
                cell3.appendChild(b);

                row.appendChild(cell3);

                var cell7 = document.createElement("td");
                console.log("Pattern:", "PARIS");
                cell7.setAttribute("border", "1px solid black");
                cell7.setAttribute("id", "patternSet");
                var t = document.createElement("input");
                t.setAttribute("type", "text");
                t.setAttribute("id", "patternText");
                t.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; text-align:center");
                t.setAttribute("placeholder", "PARIS");
                t.setAttribute("contenteditable", "true");
                t.setAttribute("oninput", "patternEntered();");
                t.setAttribute("value", "VVV ");
                cell7.appendChild(t);
                row.appendChild(cell7);

                btn = document.createElement('input');
                entry = rowData.name;
                btn.type = "button";
                btn.className = "button";
                btn.id = "sleepButton";
                btn.value = "Sleep";
                btn.onclick = (function(entry) {
                    return function() {
                        sleepAction();
                    }
                })(entry);

                cell0 = document.createElement("td");
                cell0.setAttribute("border", "1px solid black");
                cell0.appendChild(btn);
                row.appendChild(cell0);


            }

            return row;
        }

        g_timeUpdateTimer = setInterval(function() {
            updateDisplayedLocalTime();

            if (g_stillConnected) {
                if (g_stillConnected) {
                    g_stillConnected--;
                    if (g_stillConnected == 0) {
                        setOverlay("Disconnected");
                        console.log("g_stillConnected timeout!!");
                        g_timedOut = true;
                        g_stillDisconnected = 20;
                    }
                }
            } else {
                if (g_stillDisconnected) {
                    g_stillDisconnected--;
                    if (g_stillDisconnected == 0) {
                        g_stillDisconnected = 20;
                        //                webSocketStart();
                        //                console.log("Disconnected! Started new websocket");
                        console.log("Disconnected!");
                    }
                }
            }
        }, 1000);

        function webSocketStart() {
            var websocketcreated = true;
            var host = String(window.location.hostname);

            console.log("Host: " + host);

            if (host.length > 0) {
                if (g_websock != null) // socket already exists
                {
                    g_websock.close();
                    g_websock = null;
                }

                try {
                    g_numberOfOpenWebSockets++;
                    g_websock = new WebSocket("ws://" + window.location.hostname + ":81/");
                } catch (err) {
                    document.getElementById("xmtrTime").innerHTML = "Disconnected";
                    console.log("Unable to create web socket");
                    websocketcreated = false;
                    setOverlay("Disconnected\nNo Socket");
                    if (g_numberOfOpenWebSockets) g_numberOfOpenWebSockets--;
                }
            } else {
                document.getElementById("xmtrTime").innerHTML = "Disconnected\nNo Socket Host";
                console.log("No websocket host available.");
                websocketcreated = false;
                g_websock = null;
                setOverlay("Disconnected");
            }

            if (websocketcreated == true) {
                document.getElementById("xmtrTime").innerHTML = "Connected";
                //                sendToSocket("EVENT_NAME,TEST!");

                g_websock.onopen = function(evt) {
                    console.log("websock open");
                    websocketcreated = true;
                    g_stillConnected = Math.max(20, g_stillConnected);
                };

                g_websock.onclose = function(evt) {
                    if (g_numberOfOpenWebSockets) g_numberOfOpenWebSockets--;

                    if (g_numberOfOpenWebSockets == 0) {
                        console.log("all websocks closed");
                        if (websocketcreated == true) { // handle test case where server refuses websocket
                            setOverlay("Disconnected");
                        }
                        websocketcreated = false;
                        g_websock = null;
                        g_stillConnected = 0;
                    } else {
                        console.log("old websock closed");
                    }
                };

                g_websock.onerror = function(evt) {
                    console.log("Websock error: " + evt);
                };

                g_websock.onmessage = function(evt) {
                    var str = evt.data;
                    var arr = str.split(",");

                    g_stillConnected = 5;
                    if (g_timedOut) {
                        g_timedOut = false;
                        setOverlay(null);
                    }

                    switch (arr[0]) {

                        case "EVENT_NAME":
                            {
                                setOverlay(null);
                                g_selectedEvent = arr[1];
                                g_typeTxNames = [];
                                g_typeFrequency = [];
                                g_selectedTxType = "";
                                hideFreqSettings();

                                hideFreqSet1();
                                updateTextFormatting();
                                //g_eventTableData = [{
                                //    name: "Event",
                                //    version: "Ver",
                                //    start: "Start",
                                //    finish: "Finish",
                                //    role: "Fox"
                                //}];
                                displayEvents(true);
                            }
                            break;

                        case "REFRESH":
                            {
                                console.log("Refresh: " + str);
                                console.log("Parsed data: " + arr[1] + "; " + arr[2] + "; " + arr[3] + "; " + arr[4] + "; " + arr[5] + "; " + arr[6] + "; " + arr[7] + ";");
                                if (typeof arr[1] == 'undefined') arr[1] = '?';
                                if (typeof arr[2] == 'undefined') arr[2] = '?';
                                if (typeof arr[3] == 'undefined') arr[3] = '0';
                                if (typeof arr[4] == 'undefined') arr[4] = '0';
                                if (typeof arr[5] == 'undefined') arr[5] = '?';
                                if (typeof arr[6] == 'undefined') arr[6] = '?';
                                if (typeof arr[7] == 'undefined') arr[7] = '?';

                                if (arr[1] == "Done") {
                                    displayEvents(false);
                                } else {
                                    var eventLine = {
                                        name: arr[1],
                                        version: arr[2],
                                        start: 1000 * Number(arr[3]),
                                        finish: 1000 * Number(arr[4]),
                                        role: arr[5],
                                        callsign: arr[6],
                                        freq: arr[7]
                                    };

                                    //var theEvent = g_eventTableData.find(g_eventTableData => g_eventTableData.name == g_selectedEvent);
                                    //theEvent.role = g_selectedTxType;
                                }
                            }
                            break;

                        case "EVENT_DATA":
                            {
                                console.log("Data: " + str);
                                console.log("Parsed data: " + arr[1] + "; " + arr[2] + "; " + arr[3] + "; " + arr[4] + "; " + arr[5] + "; " + arr[6] + "; " + arr[7] + ";" + arr[8] + ";");
                                if (typeof arr[1] == 'undefined') arr[1] = '?';
                                if (typeof arr[2] == 'undefined') arr[2] = '?';
                                if (typeof arr[3] == 'undefined') arr[3] = '0';
                                if (typeof arr[4] == 'undefined') arr[4] = '0';
                                if (typeof arr[5] == 'undefined') arr[5] = '?';
                                if (typeof arr[6] == 'undefined') arr[6] = '?';
                                if (typeof arr[7] == 'undefined') arr[7] = '?';
                                if (typeof arr[8] == 'undefined') arr[8] = '?';

                                var eventLine = {
                                    name: arr[1],
                                    version: arr[2],
                                    start: 1000 * Number(arr[3]),
                                    finish: 1000 * Number(arr[4]),
                                    role: arr[5],
                                    callsign: arr[6],
                                    freq: arr[7]
                                };
                                g_eventTableData.push(eventLine);
                            }
                            break;

                        case "TYPE_NAME":
                            {
                                if ((arr[1] == "Done") && (arr[2] == "Done")) {
                                    displayEvents(true);
                                } else {
                                    var tn = {
                                        name: arr[1],
                                        indices: arr[2]
                                    };
                                    g_typeTxNames.push(tn);
                                    console.log("TypeName = ", tn);
                                }
                            }
                            break;

                        case "FILE_VERSION":
                            {
                                //                    document.getElementById("eventFileVers").innerHTML = arr[1];
                                console.log("Event Version: ", arr[1]);
                            }
                            break;

                        case "SYNC":
                            {
                                g_transmitterTimeMs = 1000 * arr[1] + 600;
                                console.log("Tx time rcvd:", g_transmitterTimeMs);
                            }
                            break;

                        case "CLONE":
                            {
                                document.getElementById("cloneText").value = arr[1];
                            }
                            break;

                        case "VERS":
                            {
                                document.getElementById("version").innerHTML = arr[1];
                            }
                            break;

                        case "MAC":
                            {
                                var t = "MAC: " + arr[1];
                                document.getElementById("macAddress").innerHTML = t;
                                console.log(t);
                            }
                            break;

                        case "BAT":
                            {
                                var t = "Battery: " + arr[1];
                                document.getElementById("batteryLevel").innerHTML = t;
                                //              console.log(t);
                            }
                            break;

                        case "TEMP":
                            {
                                var t = "Temp: " + arr[1];
                                document.getElementById("temperature").innerHTML = t;
                                //              console.log(t);
                            }
                            break;

                        case "SSID":
                            {
                                var t = arr[1] + ": Testing";
                                document.getElementById("mainHeading").innerHTML = t;
                                console.log(t);
                            }
                            break;

                        case "CALLSIGN":
                            {
                                var c = document.getElementById("callText");
                                if (c != null) {
                                    c.value = arr[1];
                                }
                            }
                            break;

                        case "BAND":
                            {
                                var eventBand = arr[1];
                                if (eventBand.indexOf("80") > 0) {
                                    g_eventRadioBand = "80m";
                                } else {
                                    g_eventRadioBand = "2m";
                                }
                            }
                            break;

                        case "START_TIME":
                            {
                                applyNewStartTime(arr[1]);
                            }
                            break;

                        case "FINISH_TIME":
                            {
                                applyNewFinishTime(arr[1]);
                            }
                            break;

                        case "FREQ":
                            {
                                var freqStr = {
                                    frequency: arr[1],
                                    role: arr[2]
                                };
                                g_typeFrequency.push(freqStr);
                                var freq = Number(arr[1]);

                                if ((freq < Number("4000000")) && (freq > Number("3500000"))) {
                                    g_eventRadioBand = "80m";
                                } else if ((freq < Number("148000000")) && (freq > Number("144000000"))) {
                                    g_eventRadioBand = "2m";
                                }

                                console.log(g_typeFrequency.length, "Freq: ", freqStr);
                            }
                            break;

                        case "TX_ROLE":
                            {
                                var text = arr[1];

                                if (text.includes(":")) {
                                    var colon = text.indexOf(":");
                                    var newTypeIndex = parseInt(text.substring(0, colon), 10);
                                    var newSubIndex = parseInt(text.substring(colon + 1), 10);
                                    console.log("role code: ", arr[1]);
                                } else {
                                    console.log("role name: ", arr[1]);
                                }
                            }
                            break;

                        case "TEST":
                            {}
                            break;

                        default:
                            console.log("Unrecognized message: ", str);
                            break;
                    }
                }
            }
        }

        function start() {
            console.log("At start of start() function!");
            g_stillConnected = 20;
            webSocketStart();

            g_selectedEvent = "A";
            g_typeTxNames = [];

            g_selectedTxType = "";
            hideFreqSettings();

            var freq = Number(g_typeFrequency[0].frequency);

            if ((freq < Number("4000000")) && (freq > Number("3500000"))) {
                g_eventRadioBand = "80m";
            } else if ((freq < Number("148000000")) && (freq > Number("144000000"))) {
                g_eventRadioBand = "2m";
            }

            console.log(g_typeFrequency[0].length, "Freq: ", freq);

            hideFreqSet1();
            updateTextFormatting();
            g_eventTableData = [{
                name: "Power (mW)",
                version: "Modulation",
                start: "Band",
                finish: "Frequency",
                role: "Pattern",
                sleep: "Sleep"
            }];

            var eventLine = {
                name: g_powerLevel,
                version: "B",
                start: "C",
                finish: "D",
                role: "E",
                callsign: "F",
                freq: "G"
            };
            g_eventTableData.push(eventLine);
            displayEvents(true);

            console.log("At end of start() function!");
        }

        function clamp(min, num, max) {
            return num <= min ? min : num >= max ? max : num;
        }

        function sendToSocket(msg) {
            var now = Date.now();
            var dif = now - g_lastPacketTime;

            if (msg === g_lastSocketTxMessage) {
                if (msg != "TEST") {
                    console.log("Repeated command ignored!");
                    return;
                }
            }

            if (g_webSocketTxTimer != 0) {
                clearInterval(g_webSocketTxTimer);
                g_webSocketTxTimer = 0;
            }

            if ((g_websock == null) || (g_websock.readyState != g_websock.OPEN)) // wait 5 seconds and try again
            {
                if (g_websock != null) {
                    console.log("Socket not ready. Command delayed.", g_websock, g_websock.readyState);
                } else {
                    console.log("Socket null. Command delayed.");
                }

                g_webSocketTxTimer = setInterval(function() {
                    sendToSocket(msg);
                }, 5000);

            } else {
                if (dif > 100) {
                    g_websock.send(msg);
                    g_lastPacketTime = now;
                    g_lastSocketTxMessage = msg;
                } else {
                    console.log("Commands too rapid. Delaying send.");
                    g_webSocketTxTimer = setInterval(function() {
                        sendToSocket(msg);
                    }, 200);
                }
            }
        }

        function syncClock() {
            var d = Date();

            if (g_timeUpdateTimer != 0) {
                clearInterval(g_timeUpdateTimer);
                g_timeUpdateTimer = 0;
            }

            // Sync to seconds transition
            while (d == Date()) {};

            d = new Date();

            var btext = d.toISOString();
            btext = "SYNC," + btext;
            console.log(btext);
            sendToSocket(btext);

            g_timeUpdateTimer = setInterval(function() {
                if (g_stillConnected) {
                    updateDisplayedLocalTime();
                    if (g_stillConnected) {
                        g_stillConnected--;
                        if (g_stillConnected == 0) {
                            console.log("g_stillConnected timeout!");
                            setOverlay("Disconnected");
                            g_timedOut = true;
                        }
                    }
                }
            }, 1000);
        }

        function sendTest() {
            sendToSocket("TEST");
            console.log("Test message sent to socket.");

        }

        function sendRefresh() {
            sendToSocket("REFRESH");
            console.log("Refresh message sent to socket.");
        }

        function sendKeyDown() {
            var btext = "KEY_DOWN";
            console.log(btext);
            sendToSocket(btext);
        }

        function sendCall() {
            var b = document.getElementById("callText");
            var btext = "";
            if (b != null) {
                btext = b.value;
                btext = "CALLSIGN," + btext;
                sendToSocket(btext);
            }

            console.log(btext);
        }

        function sendPattern() {
            var b = document.getElementById("patternText");
            var btext = "";
            if (b != null) {
                btext = b.value;
                btext = "PATTERN," + btext;
                sendToSocket(btext);
            }

            console.log(btext);
        }


        function sendPower() {
            var power = document.getElementById("pwrSelect").value;
            var msgText = "POWER,0," + power;
            sendToSocket(msgText);
            console.log(msgText);
        }


        function sendBand() {
            var band = document.getElementById("bandSelect").value;
            var msgText = "BAND," + band;
            sendToSocket(msgText);
            console.log(msgText);
        }


        function sendModulation() {
            var modulation = document.getElementById("modSelect").value;
            var msgText = "MOD," + modulation;
            sendToSocket(msgText);
            console.log(msgText);
        }

        function sendFrequency() {
            var f;
            var band = document.getElementById("bandSelect").value;
            if (band == "80") {
                f = g_typeFrequency[0].frequency;
            } else {
                f = g_typeFrequency[1].frequency;
            }
            var msgText = "FREQ,0," + f;
            sendToSocket(msgText);
            console.log(msgText);
        }


        function sendFreq(freq) {
            var msgText = "FREQ,0," + freq;
            console.log(msgText);
            sendToSocket(msgText);
        }

        function callSignEntered() {
            var x = document.getElementById("callText");

            if (x != null) {
                var callString = x.value;
                var isValid = false;

                if (hasNumber(callString) && hasAlpha(callString) && (callString.length > 2)) {
                    x.style.color = "blue";
                    isValid = true;
                } else {
                    x.style.color = "red";
                }

                if (isValid == true) {
                    sendCall();
                }
            }
        }

        function patternEntered() {
            var x = document.getElementById("patternText");

            if (x != null) {
                var pattern = x.value.toUpperCase();
                var isValid = false;
                var valid = /^[0-9a-zA-Z<| ]+$/;

                if (pattern.length > 0) {
                    x.value = pattern;
                    if (pattern.match(valid)) {
                        x.style.color = "blue";
                        isValid = true;
                    } else {
                        x.style.color = "red";
                    }
                }

                if (isValid == true) {
                    sendPattern();
                }
            }
        }

        function currentRoleIndex() {
            g_selectedTxType = document.getElementById("roleSelect").value;
            var indices = g_typeTxNames.find(g_typeTxNames => g_typeTxNames.name == g_selectedTxType).indices;
            return Number(indices.charAt(0));
        }

        function modClick() {
            sendModulation();
        }

        function bandClick() {
            sendBand();
            var band = document.getElementById("bandSelect").value;
            var freqButton = document.getElementById("frequencyButton");
            var modulationSet = document.getElementById("modSelect");

            hideFreqSet1();

            if (band == "80") {
                g_eventRadioBand = "80m"
                updateFreqButtonText();
                freqButton.value = freqDotFormat(g_typeFrequency[0].frequency);
                modulationSet.value = "CW";
            } else {
                g_eventRadioBand = "2m";
                updateFreqButtonText()
                freqButton.value = freqDotFormat(g_typeFrequency[1].frequency);
                modulationSet.value = "AM";
            }
        }

        function pwrClick() {
            sendPower();
        }

        function setOverlay(msgTxt) {
            if (msgTxt != null) {
                document.getElementById("overlayText").innerHTML = msgTxt;
                document.getElementById("overlay").style.display = "block";
            } else {
                document.getElementById("overlay").style.display = "none";
            }
        }

        // Takes the time string argument and forces it to be UTC with seconds removed, 
        // then applies any local timezone offset to obtain local time. Returns ISO string of converted time.
        function forceValueToLocalTime(val) {
            var sub = val.slice(0, 16); // remove seconds
            sub = sub + "Z"; // for to UTC
            var d = new Date(sub);
            var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
            var t = d.getTime() + tzoffset;
            var localISOTime = "";
            if (t > 0) {
                localISOTime = (new Date(t)).toISOString();
            }

            return localISOTime;
        }

        // Force the argument to be interpreted as UTC then use it to create a Date object
        function utcTimeToLocalTime(val) {
            var z = val.indexOf("Z");

            if (z < 0) {
                val = val + "Z";
            }

            var d = new Date(val);
            return d;
        }

        // Converts the date value argument to UTC, removes seconds, and then returns as a UTC string without seconds
        // An error will result in the current time being returned as a UTC string without seconds
        function localTimeToUTC(val) {
            try {
                var d = new Date(val).toISOString();
                var sub = d.slice(0, 16); // remove seconds
                sub = sub + "Z"; // for UTC      
            } catch (err) {
                var d = new Date().toISOString();
                var sub = d.slice(0, 16); // remove seconds
                sub = sub + "Z"; // for UTC      
            }

            return sub;
        }

        function validateTimeStructure(str) {
            try {
                var d = new Date(str).toISOString();
                return true;
            } catch (err) {
                return false;
            }
        }

        function updateDisplayedLocalTime() {
            var d = Date();
            var txd = new Date(g_transmitterTimeMs);
            document.getElementById("currentTime").innerHTML = "OS: " + d;
            document.getElementById("xmtrTime").innerHTML = "TX: " + txd;
            updateTextFormatting();
        }

        function newStartTime() {
            var msgText = "";
            var dtText = document.getElementById("datetimeStart");
            var dt = dtText.value;
            var local;
            if (!validateTimeStructure(dt)) {
                local = Date();
            } else {
                local = forceValueToLocalTime(dt);
            }

            applyNewStartTime(local);
            var utc = localTimeToUTC(local);
            msgText = "START_TIME," + utc;

            console.log(msgText);
            sendToSocket(msgText);
        }

        function applyNewStartTime(t) {
            var dtText = document.getElementById("datetimeStart");
            var local;

            if (t.indexOf("Z") > 0) {
                local = utcTimeToLocalTime(t);
            } else {
                local = new Date(t);
            }

            var mon = ("0" + (local.getMonth() + 1)).slice(-2);
            var day = ("0" + local.getDate()).slice(-2);
            var hour = ("0" + local.getHours()).slice(-2);
            var min = ("0" + local.getMinutes()).slice(-2);
            var time = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;

            dtText.value = time;
        }

        function epochToLocalDateTimeFormat(epoch_ms) {
            var local = new Date(epoch_ms);

            var mon = ("0" + (local.getMonth() + 1)).slice(-2);
            var day = ("0" + local.getDate()).slice(-2);
            var hour = ("0" + local.getHours()).slice(-2);
            var min = ("0" + local.getMinutes()).slice(-2);
            var timeStr = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;

            return timeStr;
        }

        function newFinishTime() {
            var msgText = "";
            var dtText = document.getElementById("datetimeFinish");
            var dt = dtText.value;
            var local;
            if (!validateTimeStructure(dt)) {
                local = Date();
            } else {
                local = forceValueToLocalTime(dt);
            }
            applyNewFinishTime(local);
            var utc = localTimeToUTC(local);
            msgText = "FINISH_TIME," + utc;

            console.log(msgText);
            sendToSocket(msgText);
        }

        function applyNewFinishTime(t) {
            var dtText = document.getElementById("datetimeFinish");
            var local;

            if (t.indexOf("Z") > 0) {
                local = utcTimeToLocalTime(t);
            } else {
                local = new Date(t);
            }

            var mon = ("0" + (local.getMonth() + 1)).slice(-2);
            var day = ("0" + local.getDate()).slice(-2);
            var hour = ("0" + local.getHours()).slice(-2);
            var min = ("0" + local.getMinutes()).slice(-2);
            var time = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;
            dtText.value = time;
        }

        function hasNumber(myString) {
            return /\d/.test(myString);
        }

        function hasAlpha(myString) {
            return /\D/.test(myString);
        }

        function statusMessageText(startTimeEpoch, finishTimeEpoch) {
            var statusMsg;
            var s = startTimeEpoch;
            var n = (new Date).getTime();
            var f = finishTimeEpoch;

            if (s > 946684800000) s /= 1000;
            if (n > 946684800000) n /= 1000;
            if (f > 946684800000) f /= 1000;

            if (n > s) {
                if (n > f) {
                    statusMsg = "Finished";
                } else {
                    statusMsg = "Ongoing";
                }
            } else {
                statusMsg = "Scheduled";

                var del = (s - n) / 60;
                del = del.toFixed();

                if (del > 10) {
                    statusMsg = "In " + del + "m";
                } else {
                    statusMsg = "Starting";
                }
            }

            return statusMsg;
        }


        function updateTextFormatting() {
            var callsignText = document.getElementById("callText");
            var callString = "";

            if (callsignText != null) {
                callString = String(callsignText.value);
                if (hasNumber(callString) && hasAlpha(callString) && (callString.length > 2)) {
                    callsignText.style.color = "blue";
                } else {
                    callsignText.style.color = "red";
                }
            }

            if (g_stillConnected == 0) {
                setOverlay("Disconnected");
            }

            var freq1 = document.getElementById("freq1Text");

            if (freq1) {

                if (g_eventRadioBand == "2m") {
                    if ((Number(g_freq1FrequencyHz) < 144500000) || (Number(g_freq1FrequencyHz) > 144900000)) {
                        freq1.style.color = "red";
                    } else {
                        freq1.style.color = "blue";
                    }
                } else {
                    if ((g_freq1FrequencyHz < 3510000) || (g_freq1FrequencyHz > 3600000)) {
                        freq1.style.color = "red";
                    } else {
                        freq1.style.color = "blue";
                    }
                }
            }

            var fTime = document.getElementById("xmtrTime");

            if (fTime.innerHTML.indexOf("Disconnected") !== -1) {
                fTime.style.color = "red";
            } else {
                fTime.style.color = "black";
            }
        }

        function pad(num, size) {
            var s = "000000000" + num;
            return s.substr(s.length - size);
        }

        ////////////////////////////////////////////////////////////

        function updateFreqButtonText() {
            var freqButton = document.getElementById("frequencyButton");

            if (g_eventRadioBand == "80m") {
                freqButton.value = freqDotFormat(g_typeFrequency[0].frequency);
            } else {
                freqButton.value = freqDotFormat(g_typeFrequency[1].frequency);
            }
        }


        function freq1Change() {
            var freq = document.querySelector("#freq1");
            var count = document.querySelector(".freq1val");
            var f = Math.floor(freq.value);

            if (f > 0) {
                count.textContent = "\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
            } else if (f < 0) {
                count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0";
            } else {
                count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
            }

            if (g_timer != 0) {
                clearInterval(g_timer);
                g_timer = 0;
            }

            if (f != 0) {
                if (f < 0) f = -f;
                var time = 500 - (5 * f);
                g_timer = setInterval(function() {
                    incFreq1();
                }, time);
            }
        }

        ////////////////////////////////////////////////////////////

        function incFreq1Click() {
            var val;

            if (g_eventRadioBand == "2m") {
                val = Number(g_freq1FrequencyHz) + 5000;

                g_freq1FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
                g_typeFrequency[1].frequency = val;
            } else {
                val = Number(g_freq1FrequencyHz) + 100;

                g_freq1FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
                g_typeFrequency[0].frequency = val;
            }

            updateFreqButtonText();
            freq1String(val)
            sendFreq(val);
        }

        ////////////////////////////////////////////////////////////

        function decFreq1Click() {
            var val;

            if (g_eventRadioBand == "2m") {
                val = Number(g_freq1FrequencyHz) - 5000;

                g_freq1FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
                g_typeFrequency[1].frequency = val;
            } else {
                val = Number(g_freq1FrequencyHz) - 100;

                g_freq1FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
                g_typeFrequency[0].frequency = val;
            }

            updateFreqButtonText();
            freq1String(val)
            sendFreq(val);
        }

        ////////////////////////////////////////////////////////////

        function incFreq1() {
            var ftext = document.getElementById("freq1Text");
            var freq = document.querySelector("#freq1");
            var f = Math.floor(Number(freq.value));
            var val;

            if (f != 0) {
                if (g_eventRadioBand == "2m") {
                    if (f < 0) {
                        val = Number(g_freq1FrequencyHz) - 5000;
                    } else {
                        val = Number(g_freq1FrequencyHz) + 5000;
                    }

                    val = clamp(Number("144000000"), val, Number("148000000"));
                    g_typeFrequency[1].frequency = val;
                } else {
                    if (f < 0) {
                        val = Number(g_freq1FrequencyHz) - 100;
                    } else {
                        val = Number(g_freq1FrequencyHz) + 100;
                    }

                    val = clamp(Number("3500000"), val, Number("4000000"));
                    g_typeFrequency[0].frequency = val;
                }

                updateFreqButtonText();
                freq1String(val);
                sendFreq(val);
            } else {
                clearInterval(g_timer);
                g_timer = 0;
            }
        }

        ////////////////////////////////////////////////////////////

        function resetFreq1Slider() {
            var freq = document.querySelector("#freq1");
            var count = document.querySelector(".freq1val");

            freq.value = 0;
            count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
        }

        ////////////////////////////////////////////////////////////

        function freq1String(myString) {
            var f = document.getElementById("freq1Text");
            g_freq1FrequencyHz = myString;
            if (f) f.value = freqDotFormat(myString);
        }

        function freqDotFormat(freqString) {
            var val = Number(freqString);
            var newString = String(Math.floor(val / 1000000)) + "." + pad(Math.floor(((val % 1000000) / 1000)), 3) + "." + pad((val % 1000), 3);
            return newString;
        }

        ////////////////////////////////////////////////////////////

        function toggleFreqSettings() {
            var x1 = document.getElementById("freqSet1");

            if (x1.style.display == "block") {
                hideFreqSettings();
            } else {
                showFreqSettings();
            }
        }

        function showFreqSettings() {

            showFreqSet1();

            if (g_eventRadioBand == "2m") {
                freqStr = g_typeFrequency[1].frequency;
                freq1String(freqStr);
                document.getElementById("freqSet1Heading").innerHTML = g_typeFrequency[1].role + " Frequency";
            } else {
                freqStr = g_typeFrequency[0].frequency;
                freq1String(freqStr);
                document.getElementById("freqSet1Heading").innerHTML = g_typeFrequency[0].role + " Frequency";
            }
        }

        function hideFreqSettings() {
            hideFreqSet1();
        }

        ////////////////////////////////////////////////////////////

        function showFreqSet1() {
            var x = document.getElementById("freqSet1");
            x.style.display = "block";

        }

        function hideFreqSet1() {
            var x = document.getElementById("freqSet1");
            x.style.display = "none";
        }

        ////////////////////////////////////////////////////////////

        window.addEventListener("mouseup", function() {
            if (document.getElementById("freq1").value != 0) {
                resetFreq1Slider();
            }
        });

        window.addEventListener("touchend", function() {
            if (document.getElementById("freq1").value != 0) {
                resetFreq1Slider();
            }
        });

        window.addEventListener("click", function() {
            if (document.getElementById("freq1").value != 0) {
                resetFreq1Slider();
            }
        });

        ////////////////////////////////////////////////////////////

    </script>


    <div id="overlay">
        <div id="overlayText">Connecting...</div>
    </div>

    <center>
        <h1 id="mainHeading" style="font-family:verdana; font-size:30px; color:Black; text-align:center;">Transmitter Test</h1>
        <p id="version" style="font-family:verdana; font-size:12px; color:Black; text-align:center;">HTML Ver 0.1.9 - 16 Mar 2019</p>

        <div>
            <table>
                <tr>
                    <td style="width:200px; height:50px; text-align:right; vertical-align:middle;">
                        <p id="batteryLevel" style="font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;">Battery: ?</p>
                    </td>
                    <td style="width:200px; height:50px; text-align:right; vertical-align:middle;">
                        <p id="temperature" style="font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;">Temp: ?</p>
                    </td>
                </tr>
            </table>

            <table>
                <tr>
                    <td style="text-align:right;">
                        <p id="xmtrTime" style="font-family:verdana; font-size:20px; color:Red; font-weight:bold; text-align:center;">Disconnected</p>
                    </td>
                </tr>
            </table>

            <table>
                <tr>
                    <td style="text-align:right;">
                        <p id="currentTime" style="font-family:verdana; font-size:20px; color:Black; font-weight:bold; text-align:center;">Updating...</p>
                    </td>
                </tr>
            </table>

            <table>
                <tr>
                    <td style="text-align:left; vertical-align:center;">
                        <button id="SyncButton" class="incbutton" onclick="syncClock();">Sync</button>
                    </td>
                </tr>
            </table>


            <table border="1" id="eventTable"></table>


        </div>

        <div id="freqSet1" style="display:none;">
            <h4 id="freqSet1Heading" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center">Fox Frequency</h4>

            <table>
                <tr>
                    <td>
                        <button id="FreqDownButton" class="decbutton" onclick="decFreq1Click();">DEC</button>
                    </td>

                    <td>
                        <input type="text" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center" id="freq1Text" name="freq1Text" value="" readonly="readonly" />
                    </td>

                    <td style="width:14.4px; text-align: left">
                        <button id="FreqUpButton" class="incbutton" onclick="incFreq1Click();">INC</button>
                    </td>
                </tr>
            </table>

            <div>
                <span class="freq1val" style="text-align:center; color:black"></span>

                <table>
                    <tr>
                        <td></td>

                        <td style="width:400px; text-align:center">
                            <input style="font-family:verdana; font-size:20px; width:400px; text-align:center; color:black; font-weight:bold;" type="range" name="freq1" id="freq1" min="-100" max="100" step="1" value="0" oninput="freq1Change();" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <h3 id="macAddress" style="font-family:verdana; font-size:15px; font-weight:bold; text-align:center">Waiting for MAC Address</h3>
    </center>
</body>

</html>
