<!DOCTYPE html>

<head>
  <title>Tx</title>
  <style type="text/css">

.button {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}

.incbutton {
    background-color:blue;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}

.decbutton {
    background-color:blue;
    border: none;
    color: white;
    padding: 15px 32px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    margin: 4px 2px;
    cursor: pointer;
}

    input[type="text"]:value {
      -webkit-text-font-weight: bold;
    }
    ::placeholder {
      color: red;
      opacity: 1;
      /* Firefox */
    }
    :-ms-input-placeholder {
      /* Internet Explorer 10-11 */
      
      color: red;
    }
    ::-ms-input-placeholder {
      /* Microsoft Edge */
      
      color: red;
    }
    ::-webkit-input-placeholder {
      /* Chrome/Opera/Safari */
      
      color: red;
    }
    ::-moz-placeholder {
      /* Firefox 19+ */
      
      color: red;
    }
    :-moz-placeholder {
      /* Firefox 18- */
      
      color: red;
    }
    iframe,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    blockquote,
    pre,
    a,
    abbr,
    acronym,
    address,
    big,
    cite,
    code,
    del,
    dfn,
    em,
    img,
    ins,
    kbd,
    q,
    s,
    samp,
    small,
    strike,
    strong,
    sub,
    sup,
    tt,
    var,
    b,
    u,
    i,
    center,
    dl,
    dt,
    dd,
    ol,
    ul,
    li,
    fieldset,
    form,
    label,
    legend,
    table,
    caption,
    tbody,
    tfoot,
    thead,
    tr,
    th,
    td,
    article,
    aside,
    canvas,
    details,
    embed,
    figure,
    figcaption,
    footer,
    header,
    hgroup,
    menu,
    nav,
    output,
    ruby,
    section,
    summary,
    time,
    mark,
    audio,
    video {
      margin: 0;
      /*      padding: 0; */
      /*      border: 0; */
      
      font-size: 100%;
      font: inherit;
      vertical-align: baseline;
    }
    #overlay {
      position: fixed;
      display: none;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2;
      cursor: pointer;
    }
    #overlayText {
      position: absolute;
      top: 50%;
      left: 50%;
      font-size: 50px;
      font-family: verdana;
      color: white;
      transform: translate(-50%, -50%);
      -ms-transform: translate(-50%, -50%);
    }
  </style>
</head>

<body onload="javascript:start();">
  <script type="text/javascript">
    var timer = 0;
    var timeUpdateTimer = 0;
    var homeTimer = 0;
    var eventRadioBand = "";
    var timedOut = false;

    var freq1FrequencyHz = "";
    var freq2FrequencyHz = "";
    var freq3FrequencyHz = "";
    var freq4FrequencyHz = "";

    var freq1HeaderText = "";
    var freq2HeaderText = "";
    var freq3HeaderText = "";
    var freq4HeaderText = "";

    var numberOfOpenWebSockets = 0;
    var stillConnected = 0;
    var stillDisconnected = 60;
    var lastPacketTime = 0;
    var webSocketTxTimer = 0;
    var lastSocketTxMessage;
    var transmitterTimeMs = 0;

    var g_timesync_rcvd = 0;

    ///////////////////////////////
    // Settings
    var masterCloneSetting;
    var eventName = ""; /* Human readable event name. Should contain band that is used: 80M or 2M */
    var g_eventCallsign = "Callsign"; /* Callsign for use in the selected event */
    var eventStartDateTime = "2018-01-01T00:00:00"; /* Start date and time in yyyy-mm-ddThh:mm:ssZ format */
    var eventFinishDateTime = "2018-01-01T00:00:00"; /* Finish date and time in yyyy-mm-ddThh:mm:ssZ format */
    var eventNumberOfTxTypes = 2; /* Quantity of different "roles": Home, Foxes, Fast Foxes, Slow Foxes, etc. */
    var g_typeTxName = [{name:"Name", indices:"0:0"}]; /* Human readable "role" name: "Home", and indices: "0:1" */
    var g_selectedTxType;
    var typeTxCount = []; /* Number of transmitters in a particular "role" */
    var typeFrequency = [3510000, 3600000]; /* Frequency used by transmitters in that "role" */
    var typePower = [1000, 1000]; /* Transmit power in mW for transmitters in that "role" */
    var typeWPM = []; /* Morse code speed for transmitters in that "role" */
    var typeIDinterval = [60, 60]; /* Period for sending station ID for transmitters in that "role" */
    var txDesignation = {
      typeIndex: 0,
      subIndex: 0,
      pattern: "MO"
    }; /* What role is assigned to this transmitter for this event */

    var g_eventTableData = [{
      name: "Event",
      version: "Ver",
      start: "Start",
      finish: "Finish",
      role: "Fox",
      callsign: "Call"
    }]; /* Event data to display in a table header */
    var g_selectedEvent = "";

    ///////////////////////////////

    function selectedTableRowIndex() {
      var eventNum = g_eventTableData.length;
      for (var i = 1; i < eventNum; i++) {
        if (g_selectedEvent == g_eventTableData[i].name) {
          return i;
        }
      }

      return -1;
    }

    function displayEvents() {
      var eventNum = g_eventTableData.length;
      var eventTable = document.getElementById("demo");

      var tableRows = eventTable.getElementsByTagName('tr');
      var rowCount = tableRows.length;

      console.log("rowCount = ", rowCount);

      for (var x = rowCount - 1; x >= 0; x--) {
        eventTable.removeChild(tableRows[x]);
      }

      eventTable.appendChild(eventRow(g_eventTableData[0], true));

      for (var i = 1; i < eventNum; i++) {
        eventTable.appendChild(eventRow(g_eventTableData[i], false));
      }
    }

    function eventSelect(selection) {
      if (g_selectedEvent != selection) {
        var btext = "EVENT_NAME," + selection;
        console.log(btext);
        sendToSocket(btext);
        g_selectedEvent = selection;
      }
    }

    function eventRunSelect(selection) {
      if (g_selectedEvent != selection) {
        var btext = "EVENT_NAME," + selection;
        console.log(btext);
        sendToSocket(btext);
        g_selectedEvent = selection;
      }

      sendTest();
    }

    function eventRow(rowData, isHeader) {
      var row = document.createElement("tr");
      var cellText;

      console.log("rowData = ", rowData);

      if (isHeader == true) {
        row.setAttribute("style", "font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;");

        // create cells in row
        var cell0 = document.createElement("td");
        cell0.setAttribute("border", "1px solid black");
        row.appendChild(cell0);

        var cell1 = document.createElement("td");
        cellText = document.createTextNode(rowData.name);
        cell1.setAttribute("border", "1px solid black");
        cell1.appendChild(cellText);
        row.appendChild(cell1);

        var cell2 = document.createElement("td");
        cellText = document.createTextNode(rowData.version);
        cell2.setAttribute("border", "1px solid black");
        cell2.appendChild(cellText);
        row.appendChild(cell2);

        var cell3 = document.createElement("td");
        cellText = document.createTextNode(rowData.start);
        cell3.setAttribute("border", "1px solid black");
        cell3.appendChild(cellText);
        row.appendChild(cell3);

        var cell4 = document.createElement("td");
        cellText = document.createTextNode(rowData.finish);
        cell4.setAttribute("border", "1px solid black");
        cell4.appendChild(cellText);
        row.appendChild(cell4);

        var cell5 = document.createElement("td");
        cellText = document.createTextNode("State");
        cell5.setAttribute("border", "1px solid black");
        cell5.appendChild(cellText);
        row.appendChild(cell5);

        var cell6 = document.createElement("td");
        cellText = document.createTextNode(rowData.role);
        cell6.setAttribute("border", "1px solid black");
        cell6.appendChild(cellText);
        row.appendChild(cell6);

        var cell7 = document.createElement("td");
        cellText = document.createTextNode("Call");
        cell7.setAttribute("border", "1px solid black");
        cell7.appendChild(cellText);
        row.appendChild(cell7);

        var cell8 = document.createElement("td");
        cellText = document.createTextNode("Freq");
        cell8.setAttribute("border", "1px solid black");
        cell8.appendChild(cellText);
        row.appendChild(cell8);
      } else {

        // create cells in row
        var btn = document.createElement('input');
        var entry = rowData.name;
        btn.type = "button";
        btn.className = "button";
        if (g_selectedEvent == rowData.name) {
//          btn.style = "font-family:verdana; font-size:17px; color:blue; font-weight:bold; text-align:center;");
          btn.value = "Run";
          btn.onclick = (function(entry) {
            return function() {
              eventRunSelect(entry);
            }
          })(entry);
          row.setAttribute("style", "font-family:verdana; font-size:17px; color:blue; font-weight:bold; text-align:center;");
        } else {
//          btn.style = "font-family:verdana; font-size:17px; color:black; font-weight:bold; text-align:center;");
          btn.value = "Select";
          btn.onclick = (function(entry) {
            return function() {
              eventSelect(entry);
            }
          })(entry);
          row.setAttribute("style", "font-family:verdana; font-size:15px; color:black; text-align:center;");
        }

        var cell0 = document.createElement("td");
        cell0.setAttribute("border", "1px solid black");
        cell0.appendChild(btn);
        row.appendChild(cell0);

        // create cells in row
        var cell1 = document.createElement("td");
        cellText = document.createTextNode(rowData.name);
        cell1.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {
          cell1.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; color:black; text-align:center;");
        } else {
          cell1.setAttribute("style", "font-family:verdana; font-size:15px; color:black; text-align:center;");
        }
        cell1.appendChild(cellText);
        row.appendChild(cell1);

        var cell2 = document.createElement("td");
        cellText = document.createTextNode(rowData.version);
        cell2.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {
          cell2.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; color:black; text-align:center;");
        } else {
          cell2.setAttribute("style", "font-family:verdana; font-size:15px; color:black; text-align:center;");
        }
        cell2.appendChild(cellText);
        row.appendChild(cell2);

        var cell3 = document.createElement("td");
        var start = new Date(Number(rowData.start));
        cellText = document.createTextNode(start);
        cell3.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {
          cell3.setAttribute("id", "datetimeStartCell");
          var i = document.createElement("input");
          i.setAttribute("id", "datetimeStart");
          i.setAttribute("type", "datetime-local");
          i.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; color:blue;");
          i.setAttribute("oninput", "newStartTime();");
          i.setAttribute("value", epochToLocalDateTimeFormat(rowData.start));
console.log("Start time text =", epochToLocalDateTimeFormat(rowData.start));
          cell3.appendChild(i);
        } else {
          cell3.appendChild(cellText);
        }
        row.appendChild(cell3);

        var cell4 = document.createElement("td");
        cell4.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {
          cell4.setAttribute("id", "datetimeFinishCell");
          var i = document.createElement("input");
          i.setAttribute("id", "datetimeFinish");
          i.setAttribute("type", "datetime-local");
          i.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; color:blue;");
          i.setAttribute("oninput", "newFinishTime();");
          i.setAttribute("value", epochToLocalDateTimeFormat(rowData.finish));
console.log("Start time text =", epochToLocalDateTimeFormat(rowData.finish));
          cell4.appendChild(i);
        } else {
          var finish = new Date(Number(rowData.finish));
          cellText = document.createTextNode(finish);
          cell4.appendChild(cellText);
        }
        row.appendChild(cell4);



        var cell5 = document.createElement("td");
        var stat = statusMessageText(rowData.start, rowData.finish);
console.log("Status: ", stat);
        cellText = document.createTextNode(stat);
        cell5.setAttribute("border", "1px solid black");
        cell5.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; color:black;");
        cell5.appendChild(cellText);
        row.appendChild(cell5);



        var cell6 = document.createElement("td");
        cell6.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {

          var sel = document.createElement('select'),
            option,
            i = 0,
            il = g_typeTxName.length;

          sel.setAttribute("onchange", "foxClick()");
          sel.setAttribute("id", "roleSelect");
          sel.setAttribute("style", "font-family:verdana; font-size:15px; color:blue; font-weight:bold;");

          for (; i < il; i += 1) {
            option = document.createElement('option');
            option.setAttribute('value', g_typeTxName[i].name);
            option.appendChild(document.createTextNode(g_typeTxName[i].name));
            if(g_typeTxName[i].name == rowData.role)
            {
              option.setAttribute("selected", "true");
              g_selectedTxType = rowData.role;
            }
            sel.appendChild(option);
console.log("TxType name:", g_typeTxName[i].name);
          }

          cell6.appendChild(sel);
        } else {
          cellText = document.createTextNode(rowData.role);
          cell6.appendChild(cellText);
        }
        row.appendChild(cell6);

        var cell7 = document.createElement("td");
        console.log("Event Call:", rowData.callsign);
        cell7.setAttribute("border", "1px solid black");
        if (g_selectedEvent == rowData.name) {
          cell7.setAttribute("id", "datetimeFinishCell");
          var t = document.createElement("input");
          t.setAttribute("type", "text");
          t.setAttribute("id", "callText");
          t.setAttribute("style", "font-family:verdana; font-size:15px; font-weight:bold; text-align:center");
          t.setAttribute("placeholder", "Callsign");
          t.setAttribute("contenteditable", "true");
          t.setAttribute("oninput", "callSignEntered();");
          t.setAttribute("value", rowData.callsign);
          cell7.appendChild(t);
        } else {
          cellText = document.createTextNode(rowData.callsign);
          cell7.appendChild(cellText);
        }
        row.appendChild(cell7);

        var cell8 = document.createElement("td");
        if (g_selectedEvent == rowData.name) {
          var b = document.createElement('input');
          entry = rowData.name;
          b.setAttribute("type", "button");
          b.setAttribute("class", "incbutton");
          b.setAttribute("value", "Set Freq");
          b.setAttribute("onclick", "toggleFreqSettings();");
          cell8.appendChild(b);
        }
 
        row.appendChild(cell8);
      }
      return row;
    }

    var websock = null;

    timeUpdateTimer = setInterval(function() {
      if (stillConnected) {
        updateDisplayedLocalTime();
        if (stillConnected) {
          stillConnected--;
          if (stillConnected == 0) {
            setOverlay("Disconnected");
            websock = null;
            timedOut = true;
            stillDisconnected = 20;
          }
        }
      } else {
        if (stillDisconnected) {
          stillDisconnected--;
          if (stillDisconnected == 0) {
            stillDisconnected = 20;
            //                webSocketStart();
            //                console.log("Disconnected! Started new websocket");
            console.log("Disconnected!");
          }
        }
      }
    }, 1000);

    function webSocketStart() {
      var websocketcreated = true;
      var host = String(window.location.hostname);

      console.log("Host: " + host);

      if (host.length > 0) {
        if (websock != null) // socket already exists
        {
          websock.close();
          websock = null;
        }

        try {
          numberOfOpenWebSockets++;
          websock = new WebSocket("ws://" + window.location.hostname + ":81/");
        } catch (err) {
          document.getElementById("xmtrTime").innerHTML = "Disconnected";
          console.log("Unable to create web socket");
          websocketcreated = false;
          setOverlay("Disconnected");
          if (numberOfOpenWebSockets) numberOfOpenWebSockets--;
        }
      } else {
        document.getElementById("xmtrTime").innerHTML = "Disconnected";
        console.log("No websocket host available.");
        websocketcreated = false;
        websock = null;
        setOverlay("Disconnected");
      }

      if (websocketcreated == true) {
        document.getElementById("xmtrTime").innerHTML = "Connected";
        sendToSocket("EVENT_NAME,NEW!");

        websock.onopen = function(evt) {
          console.log("websock open");
          websocketcreated = true;
          stillConnected = 5;
        };

        websock.onclose = function(evt) {
          if (numberOfOpenWebSockets) numberOfOpenWebSockets--;

          if (numberOfOpenWebSockets == 0) {
            console.log("all websocks closed");
            if (websocketcreated == true) { // handle test case where server refuses websocket
              setOverlay("Disconnected");
            }
            websocketcreated = false;
            websock = null;
            stillConnected = 0;
          } else {
            console.log("old websock closed");
          }
        };

        websock.onerror = function(evt) {
          console.log("Websock error: " + evt);
        };

        websock.onmessage = function(evt) {
          var str = evt.data;
          var arr = str.split(",");

          stillConnected = 5;
          if (timedOut) {
            timedOut = false;
            setOverlay(null);
          }

          switch (arr[0]) {

            case "EVENT_NAME":
              {
                setOverlay(null);
                g_selectedEvent = arr[1];
                g_typeTxName = [];
                typeTxCount = [];
                typeFrequency = [];
                typeWPM = [];
                typeIDinterval = [];
                typePower = []; /* Transmit power in mW for transmitters in that "role" */
                g_selectedTxType = "";
                hideFreqSettings();

                txDesignation = {
                  typeIndex: 0,
                  subIndex: 0,
                  pattern: "MO"
                };
                eventNumberOfTxTypes = 0;
                hideFreqSet1();
                hideFreqSet2();
                hideFreqSet3();
                hideFreqSet4();
                updateTextFormatting();
                g_eventTableData = [{
                  name: "Event",
                  version: "Ver",
                  start: "Start",
                  finish: "Finish",
                  role: "Fox"
                }];
                displayEvents();
              }
              break;

            case "EVENT_DATA":
              {
                console.log("Data: " + str);
                console.log("Parsed data: " + arr[1] + "; " + arr[2] + "; " + arr[3] + "; " + arr[4] + "; " + arr[5] + ";");
                if (typeof arr[1] == 'undefined') arr[1] = '?';
                if (typeof arr[2] == 'undefined') arr[2] = '?';
                if (typeof arr[3] == 'undefined') arr[3] = '0';
                if (typeof arr[4] == 'undefined') arr[4] = '0';
                if (typeof arr[5] == 'undefined') arr[5] = '?';

                var eventLine = {
                  name: arr[1],
                  version: arr[2],
                  start: 1000 * Number(arr[3]),
                  finish: 1000 * Number(arr[4]),
                  role: arr[5],
                  callsign: arr[6]
                };
                g_eventTableData.push(eventLine);
              }
              break;

            case "TYPE_NAME":
              if((arr[1] == "Done") && (arr[2] == "Done"))
              {
                displayEvents();
              }
              else
              {
                var tn = {name:arr[1], indices:arr[2]};
                g_typeTxName.push(tn);
                console.log("TypeName = ", tn);
                eventNumberOfTxTypes++;
              }
              break;

            case "FILE_VERSION":
              {
                //                    document.getElementById("eventFileVers").innerHTML = arr[1];
                console.log("Event Version: ", arr[1]);
              }
              break;

            case "SYNC":
              {
                transmitterTimeMs = 1000 * arr[1] + 500;
              }
              break;

            case "CLONE":
              document.getElementById("cloneText").value = arr[1];
              break;

            case "VERS":
              document.getElementById("version").innerHTML = arr[1];
              break;

            case "MAC":
              var t = "MAC: " + arr[1];
              document.getElementById("macAddress").innerHTML = t;
              console.log(t);
              break;

            case "BAT":
              var t = "Battery: " + arr[1];
              document.getElementById("batteryLevel").innerHTML = t;
              //              console.log(t);
              break;

            case "TEMP":
              var t = "Temp: " + arr[1];
              document.getElementById("temperature").innerHTML = t;
              //              console.log(t);
              break;

            case "SSID":
              var t = "SSID: " + arr[1];
              document.getElementById("ssid").innerHTML = t;
              console.log(t);
              break;

            case "CALLSIGN":
              var c = document.getElementById("callText");
              if (c != null) {
                c.value = arr[1];
              }
              g_eventCallsign = arr[1];
              break;

            case "BAND":
              var eventBand = arr[1];
              if (eventBand.indexOf("80") > 0) {
                eventRadioBand = "80m";
              } else {
                eventRadioBand = "2m";
              }
              break;

            case "START_TIME":
              applyNewStartTime(arr[1]);
              break;

            case "FINISH_TIME":
              applyNewFinishTime(arr[1]);
              break;

            case "TX_COUNT":
              var typeCount = typeTxCount.length + 1;
              var numTxs = arr[1];
              typeTxCount.push(numTxs);
              break;

            case "POWER":
              typePower.push(arr[1]);
              break;

            case "FREQ":
              var freqStr = arr[1];
              typeFrequency.push(freqStr);
              var freq = Number(freqStr);

              if ((freq < Number("4000000")) && (freq > Number("3500000"))) {
                eventRadioBand = "80m";
              } else if ((freq < Number("148000000")) && (freq > Number("144000000"))) {
                eventRadioBand = "2m";
              }

              break;

            case "CODE_SPEED":
              typeWPM.push(arr[1]);
              break;

            case "ID_INT":
              typeIDinterval.push(arr[1]);
              break;

            case "TX_ROLE":
              {
                var text = arr[1];

                if (text.includes(":")) {
                  var colon = text.indexOf(":");
                  var newTypeIndex = parseInt(text.substring(0, colon), 10);
                  var newSubIndex = parseInt(text.substring(colon + 1), 10);
                  txDesignation.typeIndex = newTypeIndex;
                  txDesignation.subIndex = newSubIndex;

                  console.log("typeIndex = " + txDesignation.typeIndex);
                  console.log("subIndex = " + txDesignation.subIndex);

                  msgText = "TX_ROLE," + newTypeIndex + ":" + newSubIndex;

                  sendToSocket(msgText);
                  console.log("role code: ", arr[1]);
                } else {
                  //                      var foxtext = document.getElementById("txIDText");
                  //                      foxtext.value = arr[1];
                  console.log("role name: ", arr[1]);

//                  var rolecell = document.getElementById("selectedRoleCell");
//                  rolecell.innerHTML = arr[1];
                }
              }
              break;

            case "TEST":
              {}
              break;

            default:
              break;
          }
        }
      }
    }

    function start() {
      setOverlay("Event Loading...");
      webSocketStart();

    }

    function clamp(min, num, max) {
      return num <= min ? min : num >= max ? max : num;
    }

    function sendToSocket(msg) {
      var now = Date.now();
      var dif = now - lastPacketTime;

      if (msg === lastSocketTxMessage) {
        if (msg != "TEST") {
          console.log("Repeated command ignored!");
          return;
        }
      }

      if (webSocketTxTimer != 0) {
        clearInterval(webSocketTxTimer);
        webSocketTxTimer = 0;
      }

      if ((websock == null) || (websock.readyState != websock.OPEN)) // wait 5 seconds and try again
      {
        webSocketTxTimer = setInterval(function() {
          console.log("Socket not ready. Command delayed.", websock, websock.readyState);
          sendToSocket(msg);
        }, 5000);
      } else {
        if (dif > 100) {
          websock.send(msg);
          lastPacketTime = now;
          lastSocketTxMessage = msg;
        } else {
          console.log("Commands too rapid. Delaying send.");
          webSocketTxTimer = setInterval(function() {
            sendToSocket(msg);
          }, 200);
        }
      }
    }

    function syncClock() {
      var d = Date();

      if (timeUpdateTimer != 0) {
        clearInterval(timeUpdateTimer);
        timeUpdateTimer = 0;
      }

      // Sync to seconds transition
      while (d == Date()) {
        d = Date();
      };

      d = new Date();

      var btext = d.toISOString();
      btext = "SYNC," + btext;
      console.log(btext);
      sendToSocket(btext);

      timeUpdateTimer = setInterval(function() {
        if (stillConnected) {
          updateDisplayedLocalTime();
          if (stillConnected) {
            stillConnected--;
            if (stillConnected == 0) {
              setOverlay("Disconnected");
              timedOut = true;
            }
          }
        }
      }, 1000);
    }

    function sendTest() {
      sendToSocket("TEST");
      console.log("Test message sent to socket.");

    }

    function sendCall() {
      var b = document.getElementById("callText");
      var btext = "";
      if (b != null) {
        btext = b.value;
        btext = "CALLSIGN," + btext;
        sendToSocket(btext);
      }

      console.log(btext);
    }

    function sendFreq(freq, row) {
      var msgText = "";

      switch (row) {
        case 1:
          {
            msgText = "FREQ,0," + freq;
          }
          break;

        case 2:
          {
            msgText = "FREQ,1," + freq;
          }
          break;

        case 3:
          {
            msgText = "FREQ,2," + freq;
          }
          break;

        case 4:
          {
            msgText = "FREQ,3," + freq;
          }
          break;

        default:
          {}
          break;
      }

      console.log(msgText);

      if (msgText.length != 0) {
        sendToSocket(msgText);
      }
    }

    function callSignEntered() {
      var x = document.getElementById("callText");

      if (x != null) {
        var callString = x.value;
        var isValid = false;

        if (hasNumber(callString) && hasAlpha(callString) && (callString.length > 2)) {
          x.style.color = "blue";
          isValid = true;
        } else {
          x.style.color = "red";
        }

        if (isValid == true) {
          sendCall();
        }
      }
    }

    function foxClick() {
      g_selectedTxType = document.getElementById("roleSelect").value;;
      var msgText = "TX_ROLE," + g_typeTxName.find(g_typeTxName => g_typeTxName.name == g_selectedTxType).indices;
      var theEvent = g_eventTableData.find(g_eventTableData => g_eventTableData.name == g_selectedEvent);
      theEvent.role = g_selectedTxType;
      console.log(msgText);

      if (msgText.length > 0) {
        sendToSocket(msgText);
      }
    }

    function setOverlay(msgTxt) {
      if (msgTxt != null) {
        document.getElementById("overlayText").innerHTML = msgTxt;
        document.getElementById("overlay").style.display = "block";
      } else {
        document.getElementById("overlay").style.display = "none";
      }
    }

    // Takes the time string argument and forces it to be UTC with seconds removed, 
    // then applies any local timezone offset to obtain local time. Returns ISO string of converted time.
    function forceValueToLocalTime(val) {
      var sub = val.slice(0, 16); // remove seconds
      sub = sub + "Z"; // for to UTC
      var d = new Date(sub);
      var tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
      var t = d.getTime() + tzoffset;
      var localISOTime = "";
      if (t > 0) {
        localISOTime = (new Date(t)).toISOString();
      }

      return localISOTime;
    }

    // Force the argument to be interpreted as UTC then use it to create a Date object
    function utcTimeToLocalTime(val) {
      var z = val.indexOf("Z");

      if (z < 0) {
        val = val + "Z";
      }

      var d = new Date(val);
      return d;
    }

    // Converts the date value argument to UTC, removes seconds, and then returns as a UTC string without seconds
    // An error will result in the current time being returned as a UTC string without seconds
    function localTimeToUTC(val) {
      try {
        var d = new Date(val).toISOString();
        var sub = d.slice(0, 16); // remove seconds
        sub = sub + "Z"; // for UTC      
      } catch (err) {
        var d = new Date().toISOString();
        var sub = d.slice(0, 16); // remove seconds
        sub = sub + "Z"; // for UTC      
      }

      return sub;
    }

    function validateTimeStructure(str) {
      try {
        var d = new Date(str).toISOString();
        return true;
      } catch (err) {
        return false;
      }
    }

    function updateDisplayedLocalTime() {
      var d = Date();
      var txd = "TX: " + Date(transmitterTimeMs);
      document.getElementById("currentTime").innerHTML = "OS: " + d;
      document.getElementById("xmtrTime").innerHTML = txd;
      updateTextFormatting();
    }

    function newStartTime() {
      var msgText = "";
      var dtText = document.getElementById("datetimeStart");
      var dt = dtText.value;
      var local;
      if (!validateTimeStructure(dt)) {
        local = Date();
      } else {
        local = forceValueToLocalTime(dt);
      }

      applyNewStartTime(local);
      var utc = localTimeToUTC(local);
      msgText = "START_TIME," + utc;

      console.log(msgText);
      sendToSocket(msgText);
    }

    function applyNewStartTime(t) {
      var dtText = document.getElementById("datetimeStart");
      var local;

      if (t.indexOf("Z") > 0) {
        local = utcTimeToLocalTime(t);
      } else {
        local = new Date(t);
      }

      var mon = ("0" + (local.getMonth() + 1)).slice(-2);
      var day = ("0" + local.getDate()).slice(-2);
      var hour = ("0" + local.getHours()).slice(-2);
      var min = ("0" + local.getMinutes()).slice(-2);
      var time = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;

      dtText.value = time;
    }

    function epochToLocalDateTimeFormat(epoch_ms)
    {
      var local = new Date(epoch_ms);
 
      var mon = ("0" + (local.getMonth() + 1)).slice(-2);
      var day = ("0" + local.getDate()).slice(-2);
      var hour = ("0" + local.getHours()).slice(-2);
      var min = ("0" + local.getMinutes()).slice(-2);
      var timeStr = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;

      return timeStr;
    }

    function newFinishTime() {
      var msgText = "";
      var dtText = document.getElementById("datetimeFinish");
      var dt = dtText.value;
      var local;
      if (!validateTimeStructure(dt)) {
        local = Date();
      } else {
        local = forceValueToLocalTime(dt);
      }
      applyNewFinishTime(local);
      var utc = localTimeToUTC(local);
      msgText = "FINISH_TIME," + utc;

      console.log(msgText);
      sendToSocket(msgText);
    }

    function applyNewFinishTime(t) {
      var dtText = document.getElementById("datetimeFinish");
      var local;

      if (t.indexOf("Z") > 0) {
        local = utcTimeToLocalTime(t);
      } else {
        local = new Date(t);
      }

      var mon = ("0" + (local.getMonth() + 1)).slice(-2);
      var day = ("0" + local.getDate()).slice(-2);
      var hour = ("0" + local.getHours()).slice(-2);
      var min = ("0" + local.getMinutes()).slice(-2);
      var time = local.getFullYear() + "-" + mon + "-" + day + "T" + hour + ":" + min;
      dtText.value = time;
    }

    function hasNumber(myString) {
      return /\d/.test(myString);
    }

    function hasAlpha(myString) {
      return /\D/.test(myString);
    }

    function statusMessageText(startTimeEpoch, finishTimeEpoch)
    {
      var statusMsg;
      var s = startTimeEpoch;
      var n = (new Date).getTime();
      var f = finishTimeEpoch;

      if(s>946684800000) s/= 1000;
      if(n>946684800000) n/= 1000;
      if(f>946684800000) f/=1000;

      if (n > s) {
        if (n > f) {
          statusMsg = "Finished";
        } else {
          statusMsg = "Ongoing";
        }
      } else {
        statusMsg = "Scheduled";

        var del = (s - n)/60;
        del = del.toFixed();

        if (del > 10) {
          statusMsg = "In " + del + "m";
        } else {
          statusMsg = "Starting";
        }
      }

      return statusMsg;
    }


    function updateTextFormatting() {
      var callsignText = document.getElementById("callText");
      var callString = "";

      if (callsignText != null) {
        callString = String(callsignText.value);
        if (hasNumber(callString) && hasAlpha(callString) && (callString.length > 2)) {
          callsignText.style.color = "blue";
        } else {
          callsignText.style.color = "red";
        }
      }

      if (stillConnected == 0) {
        setOverlay("Disconnected");
      }

      var freq1 = document.getElementById("freq1Text");
      var freq2 = document.getElementById("freq2Text");

      var dif12, dif13, dif14, dif23, dif24, dif34;

      if (freq1 && freq2) {
        dif12 = Math.abs(Number(freq1FrequencyHz) - Number(freq2FrequencyHz))

        var freq3 = document.getElementById("freq3Text");
        var freq4 = document.getElementById("freq4Text");

        if (eventNumberOfTxTypes < 3) {
          dif13 = 999999;
          dif14 = 999999;
          dif23 = 999999;
          dif24 = 999999;
          dif34 = 999999;
        } else {
          if (freq3 && freq4) {
            dif13 = Math.abs(Number(freq1FrequencyHz) - Number(freq3FrequencyHz));
            dif14 = Math.abs(Number(freq1FrequencyHz) - Number(freq4FrequencyHz));
            dif23 = Math.abs(Number(freq2FrequencyHz) - Number(freq3FrequencyHz));
            dif24 = Math.abs(Number(freq2FrequencyHz) - Number(freq4FrequencyHz));
            dif34 = Math.abs(Number(freq3FrequencyHz) - Number(freq4FrequencyHz));

            if (eventRadioBand == "2m") {
              if ((Number(freq3FrequencyHz) < 144500000) || (Number(freq3FrequencyHz) > 144900000) || (dif13 < 200000) || (dif23 < 200000) || (dif34 < 200000)) {
                freq3.style.color = "red";
              } else {
                freq3.style.color = "blue";
              }

              if ((Number(freq4FrequencyHz) < 144500000) || (Number(freq4FrequencyHz) > 144900000) || (dif14 < 200000) || (dif24 < 200000) || (dif34 < 200000)) {
                freq4.style.color = "red";
              } else {
                freq4.style.color = "blue";
              }
            } else {
              if ((freq3FrequencyHz < 3510000) || (freq3FrequencyHz > 3600000) || (dif13 < 20000) || (dif23 < 20000) || (dif34 < 30000)) {
                freq3.style.color = "red";
              } else {
                freq3.style.color = "blue";
              }

              if ((freq4FrequencyHz < 3510000) || (freq4FrequencyHz > 3600000) || (dif14 < 20000) || (dif24 < 20000) || (dif34 < 30000)) {
                freq4.style.color = "red";
              } else {
                freq4.style.color = "blue";
              }
            }
          }
        }

        if (eventRadioBand == "2m") {
          if ((Number(freq1FrequencyHz) < 144500000) || (Number(freq1FrequencyHz) > 144900000) || (dif12 < 200000) || (dif13 < 200000) || (dif14 < 200000)) {
            freq1.style.color = "red";
          } else {
            freq1.style.color = "blue";
          }

          if ((Number(freq2FrequencyHz) < 144500000) || (Number(freq2FrequencyHz) > 144900000) || (dif12 < 200000) || (dif23 < 200000) || (dif24 < 200000)) {
            freq2.style.color = "red";
          } else {
            freq2.style.color = "blue";
          }
        } else {
          if ((freq1FrequencyHz < 3510000) || (freq1FrequencyHz > 3600000) || (dif12 < 20000) || (dif13 < 20000) || (dif14 < 30000)) {
            freq1.style.color = "red";
          } else {
            freq1.style.color = "blue";
          }

          if ((freq2FrequencyHz < 3510000) || (freq2FrequencyHz > 3600000) || (dif12 < 20000) || (dif23 < 20000) || (dif24 < 30000)) {
            freq2.style.color = "red";
          } else {
            freq2.style.color = "blue";
          }
        }
      }

      var fTime = document.getElementById("xmtrTime");

      if (fTime.innerHTML.indexOf("Disconnected") !== -1) {
        fTime.style.color = "red";
      } else {
        fTime.style.color = "black";
      }
    }

    function pad(num, size) {
      var s = "000000000" + num;
      return s.substr(s.length - size);
    }

    ////////////////////////////////////////////////////////////

    function freq1Change() {
      var freq = document.querySelector("#freq");
      var count = document.querySelector(".freq1val");
      var f = Math.floor(freq.value);

      if (f > 0) {
        count.textContent = "\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      } else if (f < 0) {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0";
      } else {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      }

      if (timer != 0) {
        clearInterval(timer);
        timer = 0;
      }

      if (f != 0) {
        if (f < 0) f = -f;
        var time = 500 - (5 * f);
        timer = setInterval(function() {
          incFreq1();
        }, time);
      }
    }

    function freq2Change() {
      var freq = document.querySelector("#freq2");
      var count = document.querySelector(".freq2val");
      var f = Math.floor(freq.value);

      if (f > 0) {
        count.textContent = "\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      } else if (f < 0) {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0";
      } else {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      }

      if (homeTimer != 0) {
        clearInterval(homeTimer);
        homeTimer = 0;
      }

      if (f != 0) {
        if (f < 0) f = -f;
        var time = 500 - (5 * f);
        homeTimer = setInterval(function() {
          incFreq2();
        }, time);
      }
    }

    function freq3Change() {
      var freq = document.querySelector("#freq3");
      var count = document.querySelector(".freq3val");
      var f = Math.floor(freq.value);

      if (f > 0) {
        count.textContent = "\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      } else if (f < 0) {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0";
      } else {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      }

      if (timer != 0) {
        clearInterval(timer);
        timer = 0;
      }

      if (f != 0) {
        if (f < 0) f = -f;
        var time = 500 - (5 * f);
        timer = setInterval(function() {
          incFreq3();
        }, time);
      }
    }

    function freq4Change() {
      var freq = document.querySelector("#freq4");
      var count = document.querySelector(".freq4val");
      var f = Math.floor(freq.value);

      if (f > 0) {
        count.textContent = "\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      } else if (f < 0) {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0";
      } else {
        count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
      }

      if (homeTimer != 0) {
        clearInterval(homeTimer);
        homeTimer = 0;
      }

      if (f != 0) {
        if (f < 0) f = -f;
        var time = 500 - (5 * f);
        homeTimer = setInterval(function() {
          incFreq4();
        }, time);
      }
    }

    ////////////////////////////////////////////////////////////

    function incFreq1Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq1FrequencyHz) + 5000;

        freq1FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq1FrequencyHz) + 100;

        freq1FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq1String(freq1FrequencyHz)
      sendFreq(freq1FrequencyHz, 1);
    }

    function incFreq2Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq2FrequencyHz) + 5000;

        freq2FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq2FrequencyHz) + 100;

        freq2FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq2String(freq2FrequencyHz);
      sendFreq(freq2FrequencyHz, 2);
    }

    function incFreq3Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq3FrequencyHz) + 5000;

        freq3FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq3FrequencyHz) + 100;

        freq3FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq3String(freq3FrequencyHz)
      sendFreq(freq3FrequencyHz, 3);
    }

    function incFreq4Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq4FrequencyHz) + 5000;

        freq4FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq4FrequencyHz) + 100;

        freq4FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq4String(freq4FrequencyHz)
      sendFreq(freq4FrequencyHz, 4);
    }

    ////////////////////////////////////////////////////////////

    function decFreq1Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq1FrequencyHz) - 5000;

        freq1FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq1FrequencyHz) - 100;

        freq1FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq1String(freq1FrequencyHz)
      sendFreq(freq1FrequencyHz, 1);
    }

    function decFreq2Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq2FrequencyHz) - 5000;

        freq2FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq2FrequencyHz) - 100;

        freq2FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq2String(freq2FrequencyHz);
      sendFreq(freq2FrequencyHz, 2);
    }

    function decFreq3Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq3FrequencyHz) - 5000;

        freq3FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq3FrequencyHz) - 100;

        freq3FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq3String(freq3FrequencyHz)
      sendFreq(freq3FrequencyHz, 3);
    }

    function decFreq4Click() {
      var val;

      if (eventRadioBand == "2m") {
        val = Number(freq4FrequencyHz) - 5000;

        freq4FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
      } else {
        val = Number(freq4FrequencyHz) - 100;

        freq4FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
      }

      freq4String(freq4FrequencyHz)
      sendFreq(freq4FrequencyHz, 4);
    }

    ////////////////////////////////////////////////////////////

    function incFreq1() {
      var ftext = document.getElementById("freq1Text");
      var freq = document.querySelector("#freq");
      var f = Math.floor(Number(freq.value));
      var val;

      if (f != 0) {
        if (eventRadioBand == "2m") {
          if (f < 0) {
            val = Number(freq1FrequencyHz) - 5000;
          } else {
            val = Number(freq1FrequencyHz) + 5000;
          }

          freq1FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
        } else {
          if (f < 0) {
            val = Number(freq1FrequencyHz) - 100;
          } else {
            val = Number(freq1FrequencyHz) + 100;
          }

          freq1FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
        }

        freq1String(freq1FrequencyHz);
        sendFreq(freq1FrequencyHz, 1);
      } else {
        clearInterval(timer);
        timer = 0;
      }
    }

    function incFreq2() {
      var ftext = document.getElementById("freq2Text");
      var freq = document.querySelector("#freq2");
      var f = Math.floor(Number(freq.value));
      var val;

      if (f != 0) {
        if (eventRadioBand == "2m") {
          if (f < 0) {
            val = Number(freq2FrequencyHz) - 5000;

          } else {
            val = Number(freq2FrequencyHz) + 5000;
          }

          freq2FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
        } else {
          if (f < 0) {
            val = Number(freq2FrequencyHz) - 100;
          } else {
            val = Number(freq2FrequencyHz) + 100;
          }

          freq2FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
        }

        freq2String(freq2FrequencyHz);
        sendFreq(freq2FrequencyHz, 2);
      } else {
        clearInterval(homeTimer);
        homeTimer = 0;
      }
    }

    function incFreq3() {
      var ftext = document.getElementById("freq3Text");
      var freq = document.querySelector("#freq3");
      var f = Math.floor(Number(freq.value));
      var val;

      if (f != 0) {
        if (eventRadioBand == "2m") {
          if (f < 0) {
            val = Number(freq3FrequencyHz) - 5000;
          } else {
            val = Number(freq3FrequencyHz) + 5000;
          }

          freq3FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
        } else {
          if (f < 0) {
            val = Number(freq3FrequencyHz) - 100;
          } else {
            val = Number(freq3FrequencyHz) + 100;
          }

          freq3FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
        }

        freq3String(freq3FrequencyHz);
        sendFreq(freq3FrequencyHz, 3);
      } else {
        clearInterval(timer);
        timer = 0;
      }
    }

    function incFreq4() {
      var ftext = document.getElementById("freq4Text");
      var freq = document.querySelector("#freq4");
      var f = Math.floor(Number(freq.value));
      var val;

      if (f != 0) {
        if (eventRadioBand == "2m") {
          if (f < 0) {
            val = Number(freq4FrequencyHz) - 5000;

          } else {
            val = Number(freq4FrequencyHz) + 5000;
          }

          freq4FrequencyHz = clamp(Number("144000000"), val, Number("148000000"));
        } else {
          if (f < 0) {
            val = Number(freq4FrequencyHz) - 100;
          } else {
            val = Number(freq4FrequencyHz) + 100;
          }

          freq4FrequencyHz = clamp(Number("3500000"), val, Number("4000000"));
        }

        freq4String(freq4FrequencyHz);
        sendFreq(freq4FrequencyHz, 4);
      } else {
        clearInterval(homeTimer);
        homeTimer = 0;
      }
    }

    ////////////////////////////////////////////////////////////

    function resetFreq1Slider() {
      var freq = document.querySelector("#freq");
      var count = document.querySelector(".freq1val");

      freq.value = 0;
      count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
    }

    function resetFreq2Slider() {
      var freq = document.querySelector("#freq2");
      var count = document.querySelector(".freq2val");

      freq.value = 0;
      count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
    }

    function resetFreq3Slider() {
      var freq = document.querySelector("#freq3");
      var count = document.querySelector(".freq3val");

      freq.value = 0;
      count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
    }

    function resetFreq4Slider() {
      var freq = document.querySelector("#freq4");
      var count = document.querySelector(".freq4val");

      freq.value = 0;
      count.textContent = "<<<\xa0\xa0\xa0<<\xa0\xa0\xa0<\xa0\xa0\xa0>\xa0\xa0\xa0>>\xa0\xa0\xa0>>>";
    }

    ////////////////////////////////////////////////////////////

    function freq1String(myString) {
      var f = document.getElementById("freq1Text");
      var val = Number(myString);
      var newString = String(Math.floor(val / 1000000)) + "." + pad(Math.floor(((val % 1000000) / 1000)), 3) + "." + pad((val % 1000), 3);
      freq1FrequencyHz = myString;
      if (f) f.value = newString;
    }

    function freq2String(myString) {
      var f = document.getElementById("freq2Text");
      var val = Number(myString);
      var newString = String(Math.floor(val / 1000000)) + "." + pad(Math.floor(((val % 1000000) / 1000)), 3) + "." + pad((val % 1000), 3);
      freq2FrequencyHz = myString;
      if (f) f.value = newString;
    }

    function freq3String(myString) {
      var f = document.getElementById("freq3Text");
      var val = Number(myString);
      var newString = String(Math.floor(val / 1000000)) + "." + pad(Math.floor(((val % 1000000) / 1000)), 3) + "." + pad((val % 1000), 3);
      freq3FrequencyHz = myString;
      if (f) f.value = newString;
    }

    function freq4String(myString) {
      var f = document.getElementById("freq4Text");
      var val = Number(myString);
      var newString = String(Math.floor(val / 1000000)) + "." + pad(Math.floor(((val % 1000000) / 1000)), 3) + "." + pad((val % 1000), 3);
      freq4FrequencyHz = myString;
      if (f) f.value = newString;
    }

    ////////////////////////////////////////////////////////////

    function toggleFreqSettings() {
      var x = document.getElementById("freqSet1");

console.log("Toggle: ", x);

      if(x.style.display == "block")
      {
        hideFreqSettings();
      }
      else
      {
        showFreqSettings();
      }
    }

    function showFreqSettings() {
      var size = typeFrequency.length;

console.log("Show: ", size);

      switch (size) {
        case 4:
          showFreqSet4();
          freqStr = typeFrequency[3];
          freq1String(freqStr);
          document.getElementById("freqSet4Heading").innerHTML = g_typeTxName[3] + " Frequency";

        case 3:
          showFreqSet3();
          freqStr = typeFrequency[2];
          freq2String(freqStr);
          document.getElementById("freqSet3Heading").innerHTML = g_typeTxName[2] + " Frequency";

        case 2:
          showFreqSet2();
          freqStr = typeFrequency[1];
          freq3String(freqStr);
          document.getElementById("freqSet2Heading").innerHTML = g_typeTxName[1] + " Frequency";

        case 1:
          showFreqSet1();
          freqStr = typeFrequency[0];
          freq4String(freqStr);
          document.getElementById("freqSet1Heading").innerHTML = g_typeTxName[0] + " Frequency";
          break;

        default:
          break;
      }
    }

    function hideFreqSettings() {
      hideFreqSet1();
      hideFreqSet2();
      hideFreqSet3();
      hideFreqSet4();
    }

    ////////////////////////////////////////////////////////////

    function showFreqSet1() {
      var x = document.getElementById("freqSet1");
      x.style.display = "block";

    }

    function hideFreqSet1() {
      var x = document.getElementById("freqSet1");
      x.style.display = "none";
    }

    ////////////

    function showFreqSet2() {
      var x = document.getElementById("freqSet2");
      x.style.display = "block";

    }

    function hideFreqSet2() {
      var x = document.getElementById("freqSet2");
      x.style.display = "none";
    }

    ////////////

    function showFreqSet3() {
      var x = document.getElementById("freqSet3");
      x.style.display = "block";

    }

    function hideFreqSet3() {
      var x = document.getElementById("freqSet3");
      x.style.display = "none";
    }

    ////////////

    function showFreqSet4() {
      var x = document.getElementById("freqSet4");
      x.style.display = "block";

    }

    function hideFreqSet4() {
      var x = document.getElementById("freqSet4");
      x.style.display = "none";
    }

    ////////////////////////////////////////////////////////////

    window.addEventListener("mouseup", function() {
      if (document.getElementById("freq").value != 0) {
        resetFreq1Slider();
      }
    });

    window.addEventListener("touchend", function() {
      if (document.getElementById("freq").value != 0) {
        resetFreq1Slider();
      }
    });

    window.addEventListener("click", function() {
      if (document.getElementById("freq").value != 0) {
        resetFreq1Slider();
      }
    });

    ////////////

    window.addEventListener("mouseup", function() {
      if (document.getElementById("freq2").value != 0) {
        resetFreq2Slider();
      }
    });

    window.addEventListener("touchend", function() {
      if (document.getElementById("freq2").value != 0) {
        resetFreq2Slider();
      }
    });

    window.addEventListener("click", function() {
      if (document.getElementById("freq2").value != 0) {
        resetFreq2Slider();
      }
    });

    ////////////

    window.addEventListener("mouseup", function() {
      if (document.getElementById("freq3").value != 0) {
        resetFreq3Slider();
      }
    });

    window.addEventListener("touchend", function() {
      if (document.getElementById("freq3").value != 0) {
        resetFreq3Slider();
      }
    });

    window.addEventListener("click", function() {
      if (document.getElementById("freq3").value != 0) {
        resetFreq3Slider();
      }
    });

    ////////////

    window.addEventListener("mouseup", function() {
      if (document.getElementById("freq4").value != 0) {
        resetFreq4Slider();
      }
    });

    window.addEventListener("touchend", function() {
      if (document.getElementById("freq4").value != 0) {
        resetFreq4Slider();
      }
    });

    window.addEventListener("click", function() {
      if (document.getElementById("freq4").value != 0) {
        resetFreq4Slider();
      }
    });
    ////////////////////////////////////////////////////////////
  </script>


  <div id="overlay">
    <div id="overlayText">Connecting...</div>
  </div>

  <center>
    <h1 style="font-family:verdana; font-size:30px; color:Black; text-align:center;">Transmitter Settings</h1>
    <p id="version" style="font-family:verdana; font-size:12px; color:Black; text-align:center;">HTML Ver 0.1.6 - 8 Apr 2018</p>

    <div>
      <table>
        <tr>
          <td style="width:200px; height:50px; text-align:right; vertical-align:middle;">
            <p id="batteryLevel" style="font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;">Battery: ?</p>
          </td>
          <td style="width:200px; height:50px; text-align:right; vertical-align:middle;">
            <p id="temperature" style="font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;">Temp: ?</p>
          </td>
          <td style="width:200px; height:50px; text-align:right; vertical-align:middle;">
            <p id="ssid" style="font-family:verdana; font-size:15px; color:Black; font-weight:bold; text-align:center;">SSID: ?</p>
          </td>
        </tr>
      </table>

      <table>
        <tr>
          <td style="text-align:right;">
            <p id="xmtrTime" style="font-family:verdana; font-size:20px; color:Red; font-weight:bold; text-align:center;">Disconnected</p>
          </td>
        </tr>
      </table>

      <table>
        <tr>
          <td style="text-align:right;">
            <p id="currentTime" style="font-family:verdana; font-size:20px; color:Black; font-weight:bold; text-align:center;">Updating...</p>
          </td>
        </tr>
      </table>

      <table>
        <tr>
          <td style="text-align:left; vertical-align:center;">
            <button id="SyncButton" class="incbutton" onclick="syncClock();">Sync</button>
          </td>
        </tr>
      </table>


      <table border="1" cellspacing="3" id="demo"></table>


    </div>
  </center>

  <center>
    <div id="freqSet1">
      <h4 id="freqSet1Heading" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center">Fox Frequency</h4>

      <table>
        <tr>
          <td>
            <button id="FreqDownButton" class="decbutton" onclick="decFreq1Click();">DEC</button>
          </td>

          <td>
            <input type="text" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center" id="freq1Text" name="freq1Text" value="" readonly="readonly" />
          </td>

          <td style="width:14.4px; text-align: left">
            <button id="FreqUpButton" class="incbutton" onclick="incFreq1Click();">INC</button>
          </td>
        </tr>
      </table>

      <div>
        <span class="freq1val" style="text-align:center color:black"></span>

        <table>
          <tr>
            <td></td>

            <td style="width:400px; text-align:center">
              <input style="font-family:verdana; font-size:20px; width:400px; text-align:center color:black font-weight:bold;" type="range" name="freq" id="freq" min="-100" max="100" step="1" value="0" oninput="freq1Change();" />
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div id="freqSet2">
      <h4 id="freqSet2Heading" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center">Finish Frequency</h4>

      <table>
        <tr>
          <td>
            <button id="freq2DownButton" class="decbutton" onclick="decFreq2Click();">DEC</button>
          </td>

          <td style="text-align:center color:black font-weight:bold;">
            <input type="text" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center" id="freq2Text" name="freq2Text" value="" readonly="readonly" />
          </td>

          <td style="width:14.4px; text-align:left">
            <button id="freq2UpButton" class="incbutton" onclick="incFreq2Click();">INC</button>
          </td>
        </tr>
      </table>

      <div>
        <span class="freq2val" style="text-align:center color:black"></span>

        <table>
          <tr>
            <td></td>

            <td style="width:400px; text-align: center">
              <input style="font-family:verdana; font-size:20px; width:400px; text-align:center" type="range" name="freq2" id="freq2" min="-100" max="100" step="1" value="0" oninput="freq2Change();" />
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div id="freqSet3">
      <h4 id="freqSet3Heading" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center">Frequency3</h4>

      <table>
        <tr>
          <td>
            <button id="freq3DownButton" class="decbutton" onclick="decFreq3Click();">DEC</button>
          </td>

          <td>
            <input type="text" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center" id="freq3Text" name="freq3Text" value="" readonly="readonly" />
          </td>

          <td style="width:14.4px; text-align: left">
            <button id="freq3UpButton" class="incbutton" onclick="incFreq3Click();">INC</button>
          </td>
        </tr>
      </table>

      <div>
        <span class="freq3val" style="text-align:center color:black"></span>

        <table>
          <tr>
            <td></td>

            <td style="width:400px; text-align:center">
              <input style="width:400px; text-align:center color:black font-weight:bold;" type="range" name="freq3" id="freq3" min="-100" max="100" step="1" value="0" oninput="freq3Change();" />
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div id="freqSet4">
      <h4 id="freqSet4Heading" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center">Frequency4</h4>

      <table>
        <tr>
          <td>
            <button id="freq4DownButton" class="decbutton" onclick="decFreq4Click();">DEC</button>
          </td>

          <td>
            <input type="text" style="font-family:verdana; font-size:20px; font-weight:bold; text-align:center" id="freq4Text" name="freq4Text" value="" readonly="readonly" />
          </td>

          <td style="width:14.4px; text-align: left">
            <button id="freq4UpButton" class="incbutton" onclick="incFreq4Click();">INC</button>
          </td>
        </tr>
      </table>

      <div>
        <span class="freq4val" style="text-align:center color:black"></span>

        <table>
          <tr>
            <td></td>

            <td style="width:400px; text-align:center">
              <input style="font-family:verdana; font-size:20px; width:400px; text-align:center color:black font-weight:bold;" type="range" name="freq4" id="freq4" min="-100" max="100" step="1" value="0" oninput="freq4Change();" />
            </td>
          </tr>
        </table>
      </div>
    </div>

    <h3 id="macAddress" style="font-family:verdana; font-size:15px; font-weight:bold; text-align:center">Waiting for MAC Address</h3>
  </center>
</body>

</html>